<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ndarboe.net</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f6fa; font-size:12px; }
.app-header { background:#34495e; color:white; padding:10px; display:flex; align-items:center; justify-content:space-between; font-size:14px; }
.menu button { background:#2c3e50; color:white; border:none; padding:5px 10px; margin-left:5px; cursor:pointer; border-radius:5px; font-size:12px; }
.menu button.active { background:#1abc9c; }
main { padding:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; }
th, td { border:1px solid #ccc; padding:4px; text-align:left; height:24px; }
th { background:#34495e; color:white; font-size:12px; }
td.num { text-align:right; }
td.red { background:red; color:white; }
td.green { background:green; color:white; }
.tab-content { display:none; }
.tab-content.active { display:block; }
button.save-btn, button.edit-btn, button.delete-btn, button.add-btn { padding:3px 6px; border:none; border-radius:3px; cursor:pointer; margin:1px; font-size:11px; }
button.save-btn { background:#1abc9c; color:white; }
button.edit-btn { background:#f39c12; color:white; }
button.delete-btn { background:#e74c3c; color:white; }
button.add-btn { background:#2980b9; color:white; margin-bottom:5px; }
.filter-input { margin-right:5px; padding:2px; border-radius:3px; border:1px solid #ccc; font-size:11px; width:100px; }
.progress-container { background:#ddd; border-radius:5px; margin-top:5px; height:15px; width:100%; }
.progress-bar { height:100%; width:0; background:#1abc9c; border-radius:5px; text-align:center; color:white; line-height:15px; font-size:11px; }
textarea { width:100%; height:60px; font-size:12px; margin-top:5px; }
</style>
</head>
<body>

<header class="app-header">
    <h1>Ndarboe.net</h1>
    <nav class="menu">
        <button class="tab-btn active" data-tab="component">Component</button>
        <button class="tab-btn" data-tab="changeout">Change Out</button>
        <button class="tab-btn" data-tab="currentsmu">Current SMU</button>
    </nav>
</header>

<main>
<!-- Menu 1: Component -->
<section id="component" class="tab-content active">
    <div>
        <input type="text" class="filter-input" placeholder="Filter Equipment" onkeyup="filterTable('component','0',this.value)">
        <input type="text" class="filter-input" placeholder="Filter Component" onkeyup="filterTable('component','2',this.value)">
        <button class="add-btn" onclick="addRow('component')">Add New</button>
        <button class="save-btn" onclick="saveJSON('component')">Save JSON</button>
        <button class="add-btn" onclick="loadJSON('component')">Load JSON</button>
    </div>
    <table id="component-table">
        <thead>
            <tr>
                <th>Equipment</th><th>Model</th><th>Component</th><th>Freq</th><th>Cost</th>
                <th>Change Out</th><th>Current SMU</th><th>Next Change</th><th>Life</th><th>Life %</th><th>Remarks</th><th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<!-- Menu 2: Change Out -->
<section id="changeout" class="tab-content">
    <div>
        <input type="text" class="filter-input" placeholder="Filter Equipment" onkeyup="filterTable('changeout','0',this.value)">
        <input type="text" class="filter-input" placeholder="Filter Component" onkeyup="filterTable('changeout','1',this.value)">
        <button class="add-btn" onclick="addRow('changeout')">Add New</button>
        <button class="save-btn" onclick="saveJSON('changeout')">Save JSON</button>
        <button class="add-btn" onclick="loadJSON('changeout')">Load JSON</button>
    </div>
    <table id="changeout-table">
        <thead>
            <tr>
                <th>Equipment</th><th>Component</th><th>Change Out</th><th>Remarks</th><th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<!-- Menu 3: Current SMU -->
<section id="currentsmu" class="tab-content">
    <p>Paste Equipment & SMU (misal copy dari Excel, tab/space dipisah):</p>
    <textarea id="smu-paste"></textarea>
    <button class="add-btn" onclick="pasteSMU()">Paste</button>
    <table id="smu-table">
        <thead>
            <tr><th>Equipment</th><th>SMU</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <button class="save-btn" onclick="updateSMU()">Update Current SMU</button>
    <div class="progress-container"><div class="progress-bar" id="progress-bar">0%</div></div>
</section>

</main>

<script>
// Tab Menu
const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        const target = tab.getAttribute('data-tab');
        contents.forEach(c=>c.classList.remove('active'));
        document.getElementById(target).classList.add('active');
    });
});

// Add New Row
function addRow(menu){
    const table = document.getElementById(menu+'-table').getElementsByTagName('tbody')[0];
    let row = table.insertRow();
    if(menu=='component'){
        row.innerHTML = `<td></td><td></td><td></td><td class="num"></td><td class="num"></td>
        <td class="num"></td><td class="num"></td><td class="num"></td><td class="num"></td><td class="num"></td><td></td>
        <td>
        <button class="edit-btn" onclick="editRow(this)">Edit</button>
        <button class="save-btn" onclick="saveRow(this)">Save</button>
        <button class="delete-btn" onclick="deleteRow(this)">Delete</button>
        </td>`;
    } else {
        row.innerHTML = `<td></td><td></td><td class="num"></td><td></td>
        <td>
        <button class="edit-btn" onclick="editRow(this)">Edit</button>
        <button class="save-btn" onclick="saveRow(this);syncChangeOut();">Save</button>
        <button class="delete-btn" onclick="deleteRow(this);syncChangeOut();">Delete</button>
        </td>`;
    }
}

// Edit/Save/Delete Row
function editRow(btn){ alert("Kolom tidak bisa diubah, gunakan Add/Delete row."); }
function saveRow(btn){ recalcComponent(); }
function deleteRow(btn){ btn.closest('tr').remove(); recalcComponent(); }

// Filter Table
function filterTable(menu,colIndex,value){
    const table = document.getElementById(menu+'-table');
    const trs = table.tBodies[0].rows;
    for(let tr of trs){
        let cell = tr.cells[colIndex].innerText.toLowerCase();
        tr.style.display = cell.includes(value.toLowerCase())?'':'none';
    }
}

// Change Out Sync to Component
function syncChangeOut(){
    const coTable = document.getElementById('changeout-table').tBodies[0].rows;
    const compTable = document.getElementById('component-table').tBodies[0].rows;
    let maxChange = {}, remarksMap={};
    for(let r of coTable){
        let key = r.cells[0].innerText+'|'+r.cells[1].innerText;
        maxChange[key] = 1; // numerical for calculation
        remarksMap[key] = r.cells[3].innerText;
    }
    for(let r of compTable){
        let key = r.cells[0].innerText+'|'+r.cells[2].innerText;
        if(maxChange[key]){
            r.cells[5].innerText = maxChange[key];
            r.cells[10].innerText = remarksMap[key];
        }
    }
    recalcComponent();
}

// Recalculate Next Change, Life, Life %
function recalcComponent(){
    const compTable = document.getElementById('component-table').tBodies[0].rows;
    for(let r of compTable){
        let freq = parseFloat(r.cells[3].innerText)||0;
        let changeOut = parseFloat(r.cells[5].innerText)||0;
        let currentSMU = parseFloat(r.cells[6].innerText)||0;
        r.cells[7].innerText = changeOut + freq;
        r.cells[7].className='num';
        r.cells[4].className='num';
        r.cells[6].className='num';
        let life = currentSMU - changeOut;
        r.cells[8].innerText = life;
        r.cells[8].className='num';
        if(life>freq){ r.cells[8].className='num red'; }
        let lifePerc = freq?Math.round((life/freq)*100):0;
        r.cells[9].innerText = lifePerc+'%';
        r.cells[9].className='num';
        if(lifePerc>100) r.cells[9].className='num red';
        else if(lifePerc>=75) r.cells[9].className='num green';
    }
}

// Menu 3: Paste SMU
function pasteSMU(){
    const text = document.getElementById('smu-paste').value.trim();
    const tbody = document.getElementById('smu-table').tBodies[0];
    tbody.innerHTML='';
    const lines = text.split(/\r?\n/);
    for(let line of lines){
        let parts = line.trim().split(/\s+/); // split by tab/space
        if(parts.length>=2){
            let row = tbody.insertRow();
            row.insertCell(0).innerText = parts[0];
            row.insertCell(1).innerText = parts[1];
        }
    }
}

// Update SMU with progress
function updateSMU(){
    const tbody = document.getElementById('smu-table').tBodies[0].rows;
    const compTable = document.getElementById('component-table').tBodies[0].rows;
    let total = tbody.length;
    let count = 0;
    if(total==0) return alert('Tidak ada data SMU untuk update');
    const progressBar = document.getElementById('progress-bar');
    function updateStep(){
        if(count>=total) { progressBar.style.width='100%'; progressBar.innerText='100%'; tbody.innerHTML=''; recalcComponent(); return; }
        let equip = tbody[count].cells[0].innerText;
        let smu = parseFloat(tbody[count].cells[1].innerText)||0;
        for(let r of compTable){
            if(r.cells[0].innerText==equip){
                r.cells[6].innerText = smu;
            }
        }
        count++;
        let perc = Math.round((count/total)*100);
        progressBar.style.width = perc+'%';
        progressBar.innerText = perc+'%';
        setTimeout(updateStep,10);
    }
    updateStep();
}

// Save JSON
function saveJSON(menu){
    const table = document.getElementById(menu+'-table');
    const data = [];
    const trs = table.tBodies[0].rows;
    for(let tr of trs){
        const obj = {};
        for(let i=0;i<tr.cells.length-1;i++){
            obj[table.tHead.rows[0].cells[i].innerText] = tr.cells[i].innerText;
        }
        data.push(obj);
    }
    const jsonStr = JSON.stringify(data,null,2);
    const blob = new Blob([jsonStr],{type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = menu+'.json'; a.click();
}

// Load JSON
function loadJSON(menu){
    const input = document.createElement('input');
    input.type='file';
    input.accept='application/json';
    input.onchange = e=>{
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev=>{
            const data = JSON.parse(ev.target.result);
            const table = document.getElementById(menu+'-table').tBodies[0];
            table.innerHTML='';
            data.forEach(obj=>{
                let row = table.insertRow();
                let keys = Object.keys(obj);
                keys.forEach((k,i)=>{
                    row.insertCell(i).innerText = obj[k];
                });
                let cell = row.insertCell(keys.length);
                cell.innerHTML=`<button class="edit-btn" onclick="editRow(this)">Edit</button>
                <button class="save-btn" onclick="saveRow(this)">Save</button>
                <button class="delete-btn" onclick="deleteRow(this);syncChangeOut();">Delete</button>`;
            });
            if(menu=='changeout') syncChangeOut();
            else recalcComponent();
        };
        reader.readAsText(file);
    };
    input.click();
}
</script>

</body>
</html>
