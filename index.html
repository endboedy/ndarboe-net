<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ndarboe.net</title>
<link rel="icon" href="data:,">
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f5f6fa; font-size:12px; }
  .app-header { background:#34495e; color:white; padding:10px; display:flex; align-items:center; justify-content:space-between; font-size:14px; }
  .menu button { background:#2c3e50; color:white; border:none; padding:5px 10px; margin-left:5px; cursor:pointer; border-radius:5px; font-size:12px; }
  .menu button.active { background:#1abc9c; }
  main { padding:10px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; font-size:12px; table-layout:fixed; }
  th, td { border:1px solid #ccc; padding:4px; text-align:left; height:20px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  th { background:#34495e; color:white; font-size:12px; }
  td.num { text-align:right; }
  td.red { background:red; color:white; }
  td.green { background:green; color:white; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }
  button.save-btn, button.edit-btn, button.delete-btn, button.add-btn, button.load-btn { padding:3px 6px; border:none; border-radius:3px; cursor:pointer; margin:1px; font-size:11px; }
  button.save-btn { background:#1abc9c; color:white; }
  button.edit-btn { background:#f39c12; color:white; }
  button.delete-btn { background:#e74c3c; color:white; }
  button.add-btn { background:#2980b9; color:white; margin-bottom:5px; }
  button.load-btn { background:#8e44ad; color:white; }
  .filter-input { margin-right:5px; padding:2px; border-radius:3px; border:1px solid #ccc; font-size:11px; width:140px; }
  .progress-container { background:#ddd; border-radius:5px; margin-top:5px; height:15px; width:100%; }
  .progress-bar { height:100%; width:0; background:#1abc9c; border-radius:5px; text-align:center; color:white; line-height:15px; font-size:11px; transition:width .2s; }
  textarea { width:100%; height:60px; font-size:12px; margin-top:5px; }
  input.inline-input { width:100%; border:none; text-align:left; font-size:12px; background:transparent; }
  input.num-input { width:100%; border:none; text-align:right; font-size:12px; background:transparent; }

  /* Equipment & Model lebih kecil */
  #component-table th:nth-child(1), #component-table td:nth-child(1),  /* Equipment */
  #component-table th:nth-child(2), #component-table td:nth-child(2)   /* Model */
  { width:80px; max-width:80px; }

  /* Perlebar kolom Component */
  #component-table th:nth-child(3), #component-table td:nth-child(3) { 
    width:260px; max-width:260px; 
  }

  /* Kolom numerik (Freq → Life %) sama lebar & rata kanan */
  #component-table th:nth-child(4), #component-table td:nth-child(4),
  #component-table th:nth-child(5), #component-table td:nth-child(5),
  #component-table th:nth-child(6), #component-table td:nth-child(6),
  #component-table th:nth-child(7), #component-table td:nth-child(7),
  #component-table th:nth-child(8), #component-table td:nth-child(8),
  #component-table th:nth-child(9), #component-table td:nth-child(9),
  #component-table th:nth-child(10), #component-table td:nth-child(10)
  { width:80px; max-width:80px; text-align:right; }

  /* Perlebar kolom Remarks */
  #component-table th:nth-child(11), #component-table td:nth-child(11) { 
    width:220px; max-width:220px; 
  }

  /* Action diperkecil tapi muat 3 tombol */
  #component-table th:nth-child(12), #component-table td:nth-child(12) { 
    width:140px; max-width:140px; text-align:center;
  }

  /* Life % pewarnaan */
  td.life-perc { font-weight:bold; text-align:right; }
  td.life-perc.red { background:#e74c3c; color:white; }
  td.life-perc.green { background:#27ae60; color:white; }
  td.life-perc.yellow { background:#f1c40f; color:black; }

  /* Pagination */
  .paging { display:flex; align-items:center; gap:6px; margin-top:6px; flex-wrap:wrap; }
  .paging button { padding:3px 8px; font-size:11px; }
  .paging .info { font-size:11px; color:#555; }
</style>
</head>
<body>

<header class="app-header">
  <h1>Ndarboe.net</h1>
  <nav class="menu">
    <button class="tab-btn active" data-tab="component">Component</button>
    <button class="tab-btn" data-tab="changeout">Change Out</button>
    <button class="tab-btn" data-tab="currentsmu">Current SMU</button>
  </nav>
</header>

<main>
  <!-- Menu 1: Component -->
  <section id="component" class="tab-content active">
    <div>
      <input id="filter-equip" type="text" class="filter-input" placeholder="Filter Equipment">
      <input id="filter-comp" type="text" class="filter-input" placeholder="Filter Component">
      <button class="add-btn" onclick="addRow('component')">Add New</button>
      <button class="save-btn" onclick="saveJSON()">Save JSON</button>
      <button class="load-btn" onclick="loadJSON()">Load JSON</button>
    </div>

    <table id="component-table">
      <thead>
        <tr>
          <th>Equipment</th>
          <th>Model</th>
          <th>Component</th>
          <th>Freq</th>
          <th>Cost</th>
          <th>Change Out</th>
          <th>Current SMU</th>
          <th>Next Change</th>
          <th>Life</th>
          <th>Life %</th>
          <th>Remarks</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="paging" id="component-paging" style="display:none;">
      <button id="pg-first" onclick="gotoPage(1)">&laquo; First</button>
      <button id="pg-prev" onclick="gotoPage(currentPage-1)">&lsaquo; Prev</button>
      <span class="info" id="pg-info">Page 1/1</span>
      <button id="pg-next" onclick="gotoPage(currentPage+1)">Next &rsaquo;</button>
      <button id="pg-last" onclick="gotoPage(totalPages)">&raquo; Last</button>
      <span class="info" id="pg-range"></span>
      <select id="page-size" onchange="changePageSize(this.value)">
        <option value="100">100</option>
        <option value="200" selected>200</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
      </select>
    </div>
  </section>

  <!-- Menu 2: Change Out -->
  <section id="changeout" class="tab-content">
    <div>
      <input type="text" class="filter-input" placeholder="Filter Equipment" onkeyup="filterTableDOM('changeout','0',this.value)">
      <input type="text" class="filter-input" placeholder="Filter Component" onkeyup="filterTableDOM('changeout','1',this.value)">
      <button class="add-btn" onclick="addRow('changeout')">Add New</button>
    </div>
    <table id="changeout-table">
      <thead>
        <tr>
          <th>Equipment</th><th>Component</th><th>Change Out</th><th>Remarks</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Menu 3: Current SMU -->
  <section id="currentsmu" class="tab-content">
    <p>Paste Equipment & SMU (misal copy dari Excel, tab/space dipisah):</p>
    <textarea id="smu-paste"></textarea>
    <button class="add-btn" onclick="pasteSMU()">Paste</button>
    <table id="smu-table">
      <thead>
        <tr><th>Equipment</th><th>SMU</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="save-btn" onclick="updateSMU()">Update Current SMU</button>
    <div class="progress-container"><div class="progress-bar" id="progress-bar">0%</div></div>
  </section>
</main>

<script>
/* ===================== STATE & UTIL ===================== */
let componentAll = [];        // semua data (array objek)
let componentFiltered = [];   // hasil filter
let currentPage = 1;
let pageSize = 200;
let totalPages = 1;

const $ = sel => document.querySelector(sel);

/* Debounce untuk filter input */
function debounce(fn, delay=200){
  let t; 
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
}

/* ===================== TABS ===================== */
const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => tab.addEventListener('click', () => {
  tabs.forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  contents.forEach(c=>c.classList.remove('active'));
  document.getElementById(tab.dataset.tab).classList.add('active');
}));

/* ===================== RENDER COMPONENT (PAGED) ===================== */
function computeFields(row){
  const freq = toNum(row['Freq']);
  const changeOut = toNum(row['Change Out']);
  const currentSMU = toNum(row['Current SMU']);
  const nextChange = changeOut + freq;
  const life = currentSMU - changeOut;
  const lifePerc = freq ? Math.round((life / freq) * 100) : 0;
  return { nextChange, life, lifePerc };
}
function toNum(v){ const n = parseFloat((v??'').toString().replace(/,/g,'')); return isNaN(n)?0:n; }

function lifePercClass(p){
  if(p > 100) return 'life-perc red';
  if(p >= 75) return 'life-perc green';
  if(p >= 50) return 'life-perc yellow';
  return 'life-perc yellow';
}

function renderComponentTable(page=1){
  if(componentFiltered.length===0){
    $('#component-table tbody').innerHTML = '';
    $('#component-paging').style.display = 'none';
    return;
  }
  totalPages = Math.max(1, Math.ceil(componentFiltered.length / pageSize));
  currentPage = Math.min(Math.max(1,page), totalPages);

  const start = (currentPage-1)*pageSize;
  const end = Math.min(start+pageSize, componentFiltered.length);
  const slice = componentFiltered.slice(start, end);

  let html = '';
  for(const row of slice){
    const { nextChange, life, lifePerc } = computeFields(row);
    html += `<tr data-id="${row._id}">
      <td>${row['Equipment']||''}</td>
      <td>${row['Model']||''}</td>
      <td>${row['Component']||''}</td>
      <td class="num">${row['Freq']||''}</td>
      <td class="num">${row['Cost']||''}</td>
      <td class="num">${row['Change Out']||''}</td>
      <td class="num">${row['Current SMU']||''}</td>
      <td class="num">${nextChange}</td>
      <td class="num">${life}</td>
      <td class="${lifePercClass(lifePerc)}">${lifePerc}%</td>
      <td>${row['Remarks']||''}</td>
      <td>
        <button class="edit-btn" onclick="editRow(this)">Edit</button>
        <button class="save-btn" onclick="saveRow(this)">Save</button>
        <button class="delete-btn" onclick="deleteRow(this)">Delete</button>
      </td>
    </tr>`;
  }
  $('#component-table tbody').innerHTML = html;

 // paging UI
('#component-paging').css('display', 'flex');
$('#pg-info').html(`Page ${currentPage} /&nbsp;${totalPages}`);
$('#pg-range').text(`${start + 1}-${end} of ${componentFiltered.length}`);
$('#pg-prev').prop('disabled', currentPage === 1);
$('#pg-first').prop('disabled', currentPage === 1);
$('#pg-next').prop('disabled', currentPage === totalPages);
$('#pg-last').prop('disabled', currentPage === totalPages);


function gotoPage(p){ renderComponentTable(p); }
function changePageSize(val){
  pageSize = parseInt(val,10)||200;
  renderComponentTable(1);
}

/* ===================== FILTER (IN-MEMORY) ===================== */
const onFilterChange = debounce(()=>{
  const fEquip = ($('#filter-equip').value||'').toLowerCase();
  const fComp  = ($('#filter-comp').value||'').toLowerCase();
  componentFiltered = componentAll.filter(r=>{
    const e = (r['Equipment']||'').toLowerCase();
    const c = (r['Component']||'').toLowerCase();
    return e.includes(fEquip) && c.includes(fComp);
  });
  renderComponentTable(1);
}, 200);

$('#filter-equip').addEventListener('keyup', onFilterChange);
$('#filter-comp').addEventListener('keyup', onFilterChange);

/* ===================== ROW OPS (Component) ===================== */
function addRow(menu){
  if(menu!=='component'){
    // menu changeout (lama, DOM-based) tetap seperti dulu
    const table = document.getElementById(menu+'-table').tBodies[0];
    let row = table.insertRow();
    row.innerHTML = `<td><input class="inline-input" placeholder="Equipment"></td>
      <td><input class="inline-input" placeholder="Component"></td>
      <td><input class="inline-input" placeholder="Change Out"></td>
      <td><input class="inline-input" placeholder="Remarks"></td>
      <td>
        <button class="edit-btn" onclick="editRow(this)">Edit</button>
        <button class="save-btn" onclick="saveRow(this);syncChangeOut();">Save</button>
        <button class="delete-btn" onclick="deleteRow(this);syncChangeOut();">Delete</button>
      </td>`;
    return;
  }

  // tambah ke data & render ulang page 1
  const newId = (componentAll.length? componentAll[componentAll.length-1]._id+1 : 1);
  const obj = {
    _id:newId,
    'Equipment':'','Model':'','Component':'',
    'Freq':'','Cost':'','Change Out':'','Current SMU':'','Remarks':''
  };
  componentAll.push(obj);
  onFilterChange(); // akan panggil render page 1
}


function rowToInputs(tr) {
  const tds = tr.cells;
  for (let i = 0; i <= 4; i++) { // Equipment, Model, Component, Freq, Cost
    const val = tds[i].innerText;
    tds[i].innerHTML = `<input class="${i >= 3 ? 'num-input' : 'inline-input'}" value="${val}">`;
  }
}

function inputsToRow(tr){
  const tds = tr.cells;
  for(let i=0;i<=4;i++){
    const inp = tds[i].querySelector('input');
    if(inp) tds[i].textContent = inp.value;
  }
}

function editRow(btn){
  const tr = btn.closest('tr');
  const parentId = tr.closest('table').id;
  if(parentId==='component-table'){
    rowToInputs(tr);
  } else if(parentId==='changeout-table'){
    for(let i=0;i<=3;i++){
      const val = tr.cells[i].innerText;
      tr.cells[i].innerHTML = <input class="inline-input" value="${val}">;
    }
  }
}

function saveRow(btn){
  const tr = btn.closest('tr');
  const tableId = tr.closest('table').id;
  if(tableId==='component-table'){
    // simpan ke DOM dulu
    inputsToRow(tr);

    // update ke data in-memory
    const id = parseInt(tr.getAttribute('data-id'),10);
    const obj = componentAll.find(x=>x._id===id);
    if(obj){
      obj['Equipment'] = tr.cells[0].innerText;
      obj['Model'] = tr.cells[1].innerText;
      obj['Component'] = tr.cells[2].innerText;
      obj['Freq'] = tr.cells[3].innerText;
      obj['Cost'] = tr.cells[4].innerText;
      // kolom 5..8 dihitung saat render
      obj['Change Out'] = tr.cells[5].innerText; // kalau diubah via syncChangeOut/updateSMU bisa berubah
      obj['Current SMU'] = tr.cells[6].innerText;
      obj['Remarks'] = tr.cells[10].innerText;
    }
    // re-render current page agar Next/Life/Life% terupdate & warna sesuai
    renderComponentTable(currentPage);
    syncChangeOut();
  } else if(tableId==='changeout-table'){
    for(let i=0;i<=3;i++){
      const inp = tr.cells[i].querySelector('input');
      if(inp) tr.cells[i].innerText = inp.value;
    }
    syncChangeOut();
  }
}

function deleteRow(btn){
  const tr = btn.closest('tr');
  const tableId = tr.closest('table').id;
  if(tableId==='component-table'){
    const id = parseInt(tr.getAttribute('data-id'),10);
    componentAll = componentAll.filter(x=>x._id!==id);
    onFilterChange(); // filter+render ulang
  } else {
    tr.remove();
    syncChangeOut();
  }
}

/* ===================== FILTER (ChangeOut lama—DOM hide/show) ===================== */
function filterTableDOM(menu,colIndex,value){
  const trs = document.getElementById(menu+'-table').tBodies[0].rows;
  const v = (value||'').toLowerCase();
  for(let tr of trs){
    let cell = tr.cells[colIndex].innerText.toLowerCase();
    tr.style.display = cell.includes(v)?'':'none';
  }
}

/* ===================== SYNC Change Out -> Component ===================== */
function syncChangeOut(){
  // ambil max change out & remarks dari tabel changeout (DOM)
  const coRows = document.getElementById('changeout-table').tBodies[0].rows;
  const maxChange = {}, remarksMap = {};
  for(let r of coRows){
    const key = (r.cells[0].innerText||'')+'|'+(r.cells[1].innerText||'');
    const val = toNum(r.cells[2].innerText);
    maxChange[key] = Math.max(maxChange[key]||0, val);
    remarksMap[key] = r.cells[3].innerText||'';
  }
  // update ke data in-memory
  for(const obj of componentAll){
    const key = (obj['Equipment']||'')+'|'+(obj['Component']||'');
    if(maxChange[key]!=null){
      obj['Change Out'] = maxChange[key].toString();
      obj['Remarks'] = remarksMap[key]||obj['Remarks']||'';
    }
  }
  renderComponentTable(currentPage);
}

/* ===================== SMU ===================== */
function pasteSMU(){
  const lines = document.getElementById('smu-paste').value.trim().split(/\r?\n/);
  const tbody = document.getElementById('smu-table').tBodies[0];
  tbody.innerHTML='';
  for(let line of lines){
    const parts = line.trim().split(/\s+/);
    if(parts.length>=2){
      let row = tbody.insertRow();
      row.insertCell(0).innerText=parts[0];
      row.insertCell(1).innerText=parts[1];
    }
  }
}

function updateSMU(){
  const rows = document.getElementById('smu-table').tBodies[0].rows;
  const progressBar = document.getElementById('progress-bar');
  const total = rows.length;
  let i=0;

  function step(){
    if(i>=total){ progressBar.style.width='100%'; progressBar.textContent='100%'; renderComponentTable(currentPage); return; }
    const equip = rows[i].cells[0].innerText;
    const smu = toNum(rows[i].cells[1].innerText);
    for(const obj of componentAll){
      if(obj['Equipment']===equip) obj['Current SMU']= smu.toString();
    }
    i++;
    const perc = Math.round(i/total*100);
    progressBar.style.width=perc+'%'; progressBar.textContent=perc+'%';
    setTimeout(step, 5);
  }
  step();
}

/* ===================== SAVE/LOAD ===================== */
function saveJSON(){
  // simpan data componentAll + changeout DOM
  const changeoutData = [];
  Array.from(document.getElementById('changeout-table').tBodies[0].rows).forEach(tr=>{
    changeoutData.push({
      "Equipment": tr.cells[0].innerText,
      "Component": tr.cells[1].innerText,
      "Change Out": tr.cells[2].innerText,
      "Remarks": tr.cells[3].innerText
    });
  });
  const payload = {
    component: componentAll.map(({_id, ...rest})=>rest),
    changeout: changeoutData
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ndarboe_data.json'; a.click();
  URL.revokeObjectURL(url);
}

/* Load JSON: support format lama (array) & baru ({component,changeout}) */
function loadJSON(){
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'application/json';
  input.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      let parsed;
      try{
        parsed = JSON.parse(ev.target.result);
      }catch(err){
        alert("File JSON tidak valid: "+err.message);
        return;
      }

      // normalisasi data component
      let comp = Array.isArray(parsed) ? parsed : (parsed.component || []);
      let chg  = Array.isArray(parsed) ? []      : (parsed.changeout || []);
      // beri _id
      componentAll = comp.map((o,idx)=>({_id:idx+1, ...o}));
      // isi tabel changeout (optional)
      const coBody = document.getElementById('changeout-table').tBodies[0];
      coBody.innerHTML='';
      if(chg.length){
        const frag = document.createDocumentFragment();
        for(const r of chg){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r["Equipment"]||''}</td>
            <td>${r["Component"]||''}</td>
            <td>${r["Change Out"]||''}</td>
            <td>${r["Remarks"]||''}</td>
            <td>
              <button class="edit-btn" onclick="editRow(this)">Edit</button>
              <button class="save-btn" onclick="saveRow(this);syncChangeOut();">Save</button>
              <button class="delete-btn" onclick="deleteRow(this);syncChangeOut();">Delete</button>
            </td>`;
          frag.appendChild(tr);
        }
        coBody.appendChild(frag);
      }
      // set filter & render pertama (cepat karena cuma 1 page)
      $('#filter-equip').value=''; $('#filter-comp').value='';
      componentFiltered = componentAll.slice();
      renderComponentTable(1);
    };
    reader.readAsText(file);
  };
  input.click();
}
</script>

</body>
</html>
